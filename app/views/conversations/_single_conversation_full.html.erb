<%= turbo_stream_from "#{current_user&.to_gid_param}:#{conversation&.to_gid_param}" %>

<% conversation.messages.ordered.each do |m| %>
  <% if current_user == m.sender %>
    <% bg_color = "bg-indigo-500" %>
    <% sender_corner = "br" %>
    <% message_align = "self-end" %>
  <% else %>
    <% bg_color = "bg-gray-500" %>
    <% sender_corner = "bl" %>
    <% message_align = "self-start" %>
  <% end %>

  <% internal_post = m.find_post_by_internal_url %>
  <% if !internal_post.blank? %>
    <% post_bg_color = "bg-[#060728]" %>
      <%= render "messages/internal_post", internal_post: internal_post , message_comment: m, post_bg_color: post_bg_color , bg_color: bg_color, sender_corner: sender_corner, message_align: message_align %>
  <% else %>
    <div class="max-w-md h-fit p-3 rounded-xl m-1 rounded-<%= sender_corner %>-none <%= message_align %> text-white <%= bg_color %> break-words" id="<%= m.id %>" data-controller="scroller">
      <%= auto_link(m.body, html: {class: "underline hover:decoration-2", rel: "nofollow", target: "_blank"}) { |text| text.gsub(/https?:\/\//, "").truncate(20) } %>
    </div>
  <% end %>
<% end %>
